# 项目完善策略与实施（审查报告）

基于对当前 multi-model-rag 前后端的完整审查，制定以下 **10+ 项** 完善策略，按优先级与工作量排序，便于依次落地。

---

## 一、健康检查增强（后端）

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 1 | **/health 依赖状态** | `/health` 除返回 `status: healthy` 外，增加对 **MySQL**、**Redis**、**向量库**（Zilliz/Qdrant）、**MinIO** 的连通性检测，返回各依赖的 `ok: true/false` 及可选错误信息，便于运维与自动恢复。 | ✅ 已实现 |

---

## 二、可观测与排障

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 2 | **请求 ID 中间件** | 为每个请求生成或透传 `X-Request-ID`，在全局异常处理中将该 ID 写入响应体（如 `detail` 或 `request_id` 字段），并在关键日志中打印，便于链路追踪。 | ✅ 已实现 |
| 3 | **统一 API 错误格式** | 全局捕获 HTTPException 与未处理异常，统一返回 `{ "detail": "...", "request_id": "xxx" }` 形态，前端可据此做统一错误提示。 | ✅ 已实现 |
| 4 | **审计日志带 request_id** | 在写入 `audit_log` 时记录当前请求的 `request_id`（若存在），便于与日志、错误响应关联排查。 | ✅ 已实现 |

---

## 三、前端体验与一致性

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 5 | **页面 title 与路由同步** | 根据当前路由设置 `document.title`（如「智能问答 - RAG 助手」「知识库 - RAG 助手」），提升多标签与收藏夹可识别性。 | ✅ 已实现 |
| 6 | **导出/下载文件名带时间戳** | 知识库导出、文件下载时，文件名增加时间戳（如 `kb_1_export_20250206_120000.zip`），避免覆盖与混淆。 | ✅ 已实现 |
| 7 | **请求超时与统一错误提示** | 对 axios 与 `fetchWithAuth`/`streamPost` 设置合理超时；超时或网络错误时在前端给出统一 toast/提示，避免静默失败。 | ✅ 已实现 |
| 8 | **空状态与无数据提示统一** | 各列表/表格无数据时使用统一 Empty 文案与可选「去上传/去创建」引导，保持体验一致。 | 待实现 |

---

## 四、安全与限流

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 9 | **敏感接口限流全覆盖** | 确认上传、对话、检索等敏感接口均挂上对应限流依赖（`require_upload_rate_limit`、`require_chat_rate_limit`、`require_search_rate_limit`），无遗漏。 | ✅ 已实现 |

---

## 五、流式与资源释放

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 10 | **流式接口客户端断开时停止** | 在 `chat/completions/stream` 中检测客户端断开（如 `request.is_disconnected()` 或等价方式），及时停止生成与资源释放，避免无效消耗。 | ✅ 已实现 |

---

## 六、用户与用量可见性

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 11 | **上次登录/最近活动展示** | 后端在登录成功时更新用户 `last_login_at`（或等价字段），`/auth/me` 返回该字段；前端在个人中心或仪表盘展示「上次登录时间」或「最近活动」，提升可感知性。 | ✅ 已实现 |

---

## 七、列表与分页

| 序号 | 策略 | 说明 | 状态 |
|------|------|------|------|
| 12 | **列表每页条数可配置** | 知识库列表、审计日志、对话历史等列表，前端支持每页条数选择（如 10/20/50），并持久化用户偏好（如 localStorage），提升大数据量下的体验。 | ✅ 已实现（审计日志） |

---

## 实施顺序建议

- **第一批（基础设施）**：1 健康检查、2 请求 ID、3 统一错误格式、4 审计 request_id  
- **第二批（前端体验）**：5 页面 title、6 导出文件名、7 超时与错误提示、8 空状态统一  
- **第三批（安全与资源）**：9 限流全覆盖、10 流式断开检测  
- **第四批（用户与列表）**：11 上次登录、12 每页条数可配置  

---

## 变更记录

| 日期 | 内容 |
|------|------|
| 2025-02-06 | 初稿：完成项目审查，列出 12 项策略并开始按序实现。 |
| 2025-02-06 | 已实现：1 健康检查、2 请求 ID 中间件、3 统一错误格式、4 审计 request_id、5 页面 title、6 导出/下载时间戳、7 超时与错误提示、9 限流全覆盖、10 流式断开检测、11 上次登录、12 审计日志每页条数可配置。待实现：8 空状态统一。 |
