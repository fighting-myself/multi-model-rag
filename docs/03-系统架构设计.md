# 系统架构设计文档

## 1. 整体架构

### 1.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                     表现层 (Presentation)                 │
│  React前端 + Nginx反向代理 + WebSocket实时通信            │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     应用层 (Application)                  │
│  FastAPI REST API + WebSocket + 业务逻辑层                │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     服务层 (Service)                      │
│  文件服务 + 向量服务 + LLM服务 + OCR服务 + 用户服务        │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     数据层 (Data)                         │
│  PostgreSQL + Redis + Qdrant + MinIO                     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 微服务架构（可选扩展）

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ 用户服务  │  │ 文件服务  │  │ 向量服务  │  │ LLM服务  │
│ User API │  │ File API │  │Vector API│  │ LLM API  │
└──────────┘  └──────────┘  └──────────┘  └──────────┘
     │            │            │            │
     └────────────┴────────────┴────────────┘
                    │
            ┌───────▼───────┐
            │  API Gateway  │
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │   前端应用     │
            └───────────────┘
```

## 2. 核心模块设计

### 2.1 用户认证模块

**功能**：
- 用户注册（邮箱/手机号）
- 用户登录（JWT Token）
- 密码重置
- 用户信息管理
- 权限控制

**技术实现**：
- JWT Token认证
- OAuth2（可选）
- Redis存储Session
- 密码加密（bcrypt）

### 2.2 文件上传模块

**功能**：
- Web界面上传（拖拽/点击）
- API批量上传
- 文件类型验证
- 文件大小限制
- 上传进度显示
- 断点续传

**技术实现**：
- 分片上传
- 文件校验（MD5）
- 异步处理（Celery）
- 存储到MinIO

### 2.3 文件解析模块

**功能**：
- PDF文本提取
- PPT内容提取
- Word文档解析
- Excel数据提取
- 图片OCR识别
- 图片内容理解

**技术实现**：
- 异步任务队列（Celery）
- 多进程处理
- 错误重试机制
- 进度回调

### 2.4 向量化模块

**功能**：
- 文本分块（chunking）
- 生成Embeddings
- 存储到向量数据库
- 元数据管理

**技术实现**：
- 滑动窗口分块
- Embedding模型调用
- Qdrant存储
- 批量处理

### 2.5 RAG检索模块

**功能**：
- 向量相似度搜索
- 混合检索（向量+关键词）
- 重排序（rerank）
- 上下文组装

**技术实现**：
- Qdrant向量搜索
- PostgreSQL全文搜索
- BM25算法（可选）
- 上下文窗口管理

### 2.6 LLM问答模块

**功能**：
- 问题理解
- 上下文注入
- 多轮对话
- 流式响应
- 多模态问答

**技术实现**：
- LLM API调用
- Prompt工程
- Stream响应
- 错误处理

### 2.7 计费模块

**功能**：
- Token计数
- 使用量统计
- 套餐管理
- 账单生成
- 支付集成

**技术实现**：
- 使用量记录
- 定时任务统计
- 第三方支付API

## 3. 数据库设计

### 3.1 PostgreSQL表结构

**users（用户表）**
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    avatar_url VARCHAR(255),
    role VARCHAR(20) DEFAULT 'user',
    plan_id INTEGER REFERENCES plans(id),
    credits DECIMAL(10, 2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);
```

**files（文件表）**
```sql
CREATE TABLE files (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    file_size BIGINT NOT NULL,
    storage_path VARCHAR(500) NOT NULL,
    md5_hash VARCHAR(32) UNIQUE,
    status VARCHAR(20) DEFAULT 'uploading',
    chunk_count INTEGER DEFAULT 0,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**knowledge_bases（知识库表）**
```sql
CREATE TABLE knowledge_bases (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    file_count INTEGER DEFAULT 0,
    chunk_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**knowledge_base_files（知识库文件关联表）**
```sql
CREATE TABLE knowledge_base_files (
    id SERIAL PRIMARY KEY,
    knowledge_base_id INTEGER REFERENCES knowledge_bases(id),
    file_id INTEGER REFERENCES files(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(knowledge_base_id, file_id)
);
```

**chunks（文档块表）**
```sql
CREATE TABLE chunks (
    id SERIAL PRIMARY KEY,
    file_id INTEGER REFERENCES files(id),
    knowledge_base_id INTEGER REFERENCES knowledge_bases(id),
    content TEXT NOT NULL,
    chunk_index INTEGER NOT NULL,
    start_char INTEGER,
    end_char INTEGER,
    metadata JSONB,
    vector_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**conversations（对话表）**
```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    knowledge_base_id INTEGER REFERENCES knowledge_bases(id),
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**messages（消息表）**
```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    conversation_id INTEGER REFERENCES conversations(id),
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    tokens INTEGER DEFAULT 0,
    model VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**usage_records（使用记录表）**
```sql
CREATE TABLE usage_records (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    record_type VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50),
    resource_id INTEGER,
    quantity DECIMAL(10, 2) NOT NULL,
    unit VARCHAR(20),
    cost DECIMAL(10, 4) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**plans（套餐表）**
```sql
CREATE TABLE plans (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    monthly_credits DECIMAL(10, 2),
    features JSONB,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Redis数据结构

**Session存储**
```
Key: session:{user_id}
Value: {token, expires_at}
TTL: 7天
```

**文件上传进度**
```
Key: upload:{file_id}
Value: {progress, chunk_status}
TTL: 24小时
```

**任务队列**
```
Key: celery:task:{task_id}
Value: {status, result}
TTL: 7天
```

**限流**
```
Key: rate_limit:{user_id}:{action}
Value: count
TTL: 1小时
```

### 3.3 Qdrant集合结构

**Collection: documents**
```json
{
  "vectors": {
    "size": 1024,  // embedding维度
    "distance": "Cosine"
  },
  "payload": {
    "chunk_id": "integer",
    "file_id": "integer",
    "knowledge_base_id": "integer",
    "content": "string",
    "metadata": "object"
  }
}
```

## 4. API设计

### 4.1 认证API

```
POST /api/v1/auth/register          # 用户注册
POST /api/v1/auth/login             # 用户登录
POST /api/v1/auth/logout            # 用户登出
POST /api/v1/auth/refresh           # 刷新Token
POST /api/v1/auth/reset-password    # 重置密码
GET  /api/v1/auth/me                # 获取当前用户信息
```

### 4.2 文件API

```
POST   /api/v1/files/upload         # 上传文件
POST   /api/v1/files/batch-upload   # 批量上传
GET    /api/v1/files                # 获取文件列表
GET    /api/v1/files/{file_id}      # 获取文件详情
DELETE /api/v1/files/{file_id}      # 删除文件
GET    /api/v1/files/{file_id}/download  # 下载文件
```

### 4.3 知识库API

```
POST   /api/v1/knowledge-bases              # 创建知识库
GET    /api/v1/knowledge-bases              # 获取知识库列表
GET    /api/v1/knowledge-bases/{kb_id}     # 获取知识库详情
PUT    /api/v1/knowledge-bases/{kb_id}     # 更新知识库
DELETE /api/v1/knowledge-bases/{kb_id}     # 删除知识库
POST   /api/v1/knowledge-bases/{kb_id}/files  # 添加文件到知识库
```

### 4.4 问答API

```
POST   /api/v1/chat/completions            # 发送消息（流式）
POST   /api/v1/chat/completions/sync       # 发送消息（同步）
GET    /api/v1/conversations                # 获取对话列表
GET    /api/v1/conversations/{conv_id}      # 获取对话详情
DELETE /api/v1/conversations/{conv_id}      # 删除对话
```

### 4.5 计费API

```
GET    /api/v1/billing/usage               # 获取使用量
GET    /api/v1/billing/plans               # 获取套餐列表
POST   /api/v1/billing/subscribe           # 订阅套餐
GET    /api/v1/billing/invoices            # 获取账单列表
```

## 5. 安全设计

### 5.1 认证安全
- JWT Token过期时间：7天
- Refresh Token过期时间：30天
- 密码加密：bcrypt（cost=12）
- 登录失败限制：5次/小时

### 5.2 API安全
- HTTPS强制
- CORS配置
- Rate Limiting
- 请求签名验证（可选）

### 5.3 数据安全
- 文件访问权限控制
- 数据加密存储
- SQL注入防护
- XSS防护

## 6. 性能优化

### 6.1 缓存策略
- Redis缓存热点数据
- CDN缓存静态资源
- 数据库查询缓存

### 6.2 异步处理
- 文件解析异步化
- 向量化异步化
- 邮件发送异步化

### 6.3 数据库优化
- 索引优化
- 查询优化
- 连接池配置
- 读写分离（可选）

### 6.4 并发处理
- 异步IO（FastAPI）
- 任务队列（Celery）
- 连接池
- 限流控制

## 7. 监控和日志

### 7.1 监控指标
- API响应时间
- 错误率
- 并发数
- 资源使用率
- 业务指标（上传数、问答数等）

### 7.2 日志级别
- ERROR：错误日志
- WARNING：警告日志
- INFO：信息日志
- DEBUG：调试日志

### 7.3 日志内容
- 请求日志（请求路径、参数、响应时间）
- 错误日志（异常堆栈）
- 业务日志（用户操作）
- 性能日志（慢查询、慢API）
