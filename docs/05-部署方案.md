# 部署方案文档

## 1. 部署架构

### 1.1 单机部署（开发/测试环境）

```
┌─────────────────────────────────────┐
│         Docker Compose              │
│  ┌──────────┐  ┌──────────┐       │
│  │  Frontend│  │  Backend │       │
│  └──────────┘  └──────────┘       │
│  ┌──────────┐  ┌──────────┐       │
│  │PostgreSQL│  │  Redis   │       │
│  └──────────┘  └──────────┘       │
│  ┌──────────┐  ┌──────────┐       │
│  │ Qdrant  │  │  MinIO   │       │
│  └──────────┘  └──────────┘       │
│  ┌──────────┐                      │
│  │ Celery  │                      │
│  └──────────┘                      │
└─────────────────────────────────────┘
```

### 1.2 生产环境部署（推荐）

```
                    ┌─────────────┐
                    │   Nginx     │
                    │  Load Balancer│
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐       ┌────▼────┐
   │ Frontend│        │ Frontend│       │ Frontend│
   │  (CDN)  │        │  (CDN)  │       │  (CDN)  │
   └─────────┘        └─────────┘       └─────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                    ┌──────▼──────┐
                    │  API Gateway│
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐       ┌────▼────┐
   │ Backend │        │ Backend │       │ Backend │
   │  Pod 1  │        │  Pod 2  │       │  Pod 3  │
   └────┬────┘        └────┬────┘       └────┬────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐       ┌────▼────┐
   │PostgreSQL│       │  Redis  │      │ Qdrant  │
   │ (Master) │       │ Cluster │      │ Cluster │
   └────┬────┘        └─────────┘      └─────────┘
        │
   ┌────▼────┐
   │PostgreSQL│
   │ (Slave) │
   └─────────┘
        │
   ┌────▼────┐
   │  MinIO  │
   │ Cluster │
   └─────────┘
```

## 2. Docker部署

### 2.1 Docker Compose配置

**docker-compose.yml**
```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: rag_db
      POSTGRES_USER: rag_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rag_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant向量数据库
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO对象存储
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 后端API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://rag_user:${POSTGRES_PASSWORD}@postgres:5432/rag_db
      REDIS_URL: redis://redis:6379/0
      QDRANT_URL: http://qdrant:6333
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
      CELERY_BROKER_URL: redis://redis:6379/1
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Worker
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://rag_user:${POSTGRES_PASSWORD}@postgres:5432/rag_db
      REDIS_URL: redis://redis:6379/0
      QDRANT_URL: http://qdrant:6333
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      CELERY_BROKER_URL: redis://redis:6379/1
    depends_on:
      - postgres
      - redis
      - qdrant
      - minio
    volumes:
      - ./backend:/app
    command: celery -A app.celery_app worker --loglevel=info

  # Celery Beat（定时任务）
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://rag_user:${POSTGRES_PASSWORD}@postgres:5432/rag_db
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
    command: celery -A app.celery_app beat --loglevel=info

  # 前端
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - backend
    environment:
      REACT_APP_API_URL: http://localhost:8000

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  minio_data:
```

### 2.2 环境变量配置

**.env.example**
```env
# 数据库
POSTGRES_PASSWORD=your_secure_password

# Redis
REDIS_PASSWORD=

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin123

# 应用密钥
SECRET_KEY=your_secret_key_here

# JWT
JWT_SECRET_KEY=your_jwt_secret_key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=10080

# AI模型配置
OPENAI_API_KEY=your_openai_api_key
OPENAI_BASE_URL=https://api.openai.com/v1
EMBEDDING_MODEL=text-embedding-3-large
LLM_MODEL=gpt-4-turbo-preview

# 本地模型配置（可选）
LOCAL_EMBEDDING_MODEL=m3e-base
LOCAL_LLM_MODEL=qwen2.5-7b
LOCAL_MODEL_BASE_URL=http://localhost:11434

# 文件上传
MAX_FILE_SIZE=104857600  # 100MB
ALLOWED_FILE_TYPES=pdf,ppt,txt,xlsx,docx,jpeg,jpg,png

# 存储
STORAGE_TYPE=minio  # minio or s3
S3_BUCKET_NAME=rag-files
S3_REGION=us-east-1
```

## 3. Kubernetes部署

### 3.1 命名空间

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: rag-system
```

### 3.2 配置映射

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: rag-config
  namespace: rag-system
data:
  DATABASE_URL: "postgresql://rag_user:password@postgres:5432/rag_db"
  REDIS_URL: "redis://redis:6379/0"
  QDRANT_URL: "http://qdrant:6333"
```

### 3.3 密钥

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: rag-secrets
  namespace: rag-system
type: Opaque
stringData:
  POSTGRES_PASSWORD: "your_password"
  SECRET_KEY: "your_secret_key"
  JWT_SECRET_KEY: "your_jwt_secret"
  OPENAI_API_KEY: "your_openai_key"
```

### 3.4 后端部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: rag-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: rag-backend:latest
        ports:
        - containerPort: 8000
        envFrom:
        - configMapRef:
            name: rag-config
        - secretRef:
            name: rag-secrets
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: rag-system
spec:
  selector:
    app: backend
  ports:
  - port: 8000
    targetPort: 8000
  type: ClusterIP
```

### 3.5 前端部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: rag-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: rag-frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: rag-system
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

### 3.6 Ingress配置

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rag-ingress
  namespace: rag-system
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - api.rag.example.com
    - app.rag.example.com
    secretName: rag-tls
  rules:
  - host: api.rag.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 8000
  - host: app.rag.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
```

## 4. 存储方案

### 4.1 文件存储

**MinIO（本地/私有云）**
- 优点：S3兼容、易于部署、成本低
- 适用：中小型部署、私有化部署

**AWS S3 / 阿里云OSS（公有云）**
- 优点：高可用、全球CDN、自动备份
- 适用：大型部署、公有云部署

### 4.2 数据库备份

**PostgreSQL备份**
```bash
# 每日备份
pg_dump -U rag_user rag_db > backup_$(date +%Y%m%d).sql

# 恢复
psql -U rag_user rag_db < backup_20240206.sql
```

**Redis备份**
- RDB快照
- AOF持久化

**Qdrant备份**
```bash
# 快照备份
curl -X POST http://qdrant:6333/collections/{collection_name}/snapshots
```

### 4.3 数据迁移

**文件迁移脚本**
```python
# 迁移MinIO到S3
from minio import Minio
import boto3

# 读取MinIO文件
# 上传到S3
```

## 5. 监控和日志

### 5.1 Prometheus监控

**指标收集**
- API请求数、响应时间
- 错误率
- 资源使用率
- 业务指标

### 5.2 Grafana仪表盘

**关键仪表盘**
- 系统健康度
- API性能
- 用户活跃度
- 成本分析

### 5.3 日志收集

**ELK Stack**
- Elasticsearch：日志存储
- Logstash：日志处理
- Kibana：日志可视化

**Loki（轻量级）**
- 与Grafana集成
- 资源占用低

## 6. 安全配置

### 6.1 SSL/TLS

**Let's Encrypt证书**
```bash
certbot --nginx -d api.rag.example.com
```

### 6.2 防火墙规则

**开放端口**
- 80/443：HTTP/HTTPS
- 22：SSH（限制IP）

**关闭端口**
- 数据库端口（仅内网访问）
- Redis端口（仅内网访问）

### 6.3 安全组配置

**AWS安全组**
- 允许80/443从0.0.0.0/0
- 允许22从特定IP
- 禁止其他端口

## 7. 扩容方案

### 7.1 水平扩容

**后端扩容**
- 增加Pod数量
- 负载均衡自动分配

**数据库扩容**
- 读写分离
- 分库分表（如需要）

### 7.2 垂直扩容

**增加资源**
- CPU：2核 → 4核 → 8核
- 内存：4GB → 8GB → 16GB

### 7.3 自动扩缩容

**HPA（Horizontal Pod Autoscaler）**
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: rag-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

## 8. 部署步骤

### 8.1 开发环境部署

```bash
# 1. 克隆代码
git clone https://github.com/your-repo/multi-model-rag.git
cd multi-model-rag

# 2. 配置环境变量
cp .env.example .env
# 编辑.env文件

# 3. 启动服务
docker-compose up -d

# 4. 初始化数据库
docker-compose exec backend alembic upgrade head

# 5. 访问应用
# 前端：http://localhost:3000
# 后端API：http://localhost:8000
# API文档：http://localhost:8000/docs
```

### 8.2 生产环境部署

```bash
# 1. 构建镜像
docker build -t rag-backend:latest ./backend
docker build -t rag-frontend:latest ./frontend

# 2. 推送到镜像仓库
docker push rag-backend:latest
docker push rag-frontend:latest

# 3. 部署到K8s
kubectl apply -f k8s/

# 4. 检查状态
kubectl get pods -n rag-system
kubectl get services -n rag-system
```

## 9. 回滚方案

### 9.1 代码回滚

```bash
# Git回滚
git revert HEAD
git push

# 重新部署
docker-compose up -d --build
```

### 9.2 K8s回滚

```bash
# 查看历史版本
kubectl rollout history deployment/backend -n rag-system

# 回滚到上一版本
kubectl rollout undo deployment/backend -n rag-system

# 回滚到指定版本
kubectl rollout undo deployment/backend --to-revision=2 -n rag-system
```

## 10. 灾难恢复

### 10.1 备份策略

- 数据库：每日全量备份 + 每小时增量备份
- 文件：实时同步到备份存储
- 配置：版本控制（Git）

### 10.2 恢复流程

1. 恢复数据库
2. 恢复文件存储
3. 恢复配置
4. 重启服务
5. 验证功能
