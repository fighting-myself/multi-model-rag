# 环境与启动指南

本文说明项目**必须准备的环境**、**必须的配置**以及**启动方式**。

---

## 一、必须准备的环境

### 方式 A：Docker 一键运行（推荐）

只需安装：

| 环境 | 版本要求 | 说明 |
|------|----------|------|
| **Docker** | 20.10+ | 用于运行所有后端服务 |
| **Docker Compose** | 2.0+ | 用于编排多容器 |

安装后无需单独安装 PostgreSQL、Redis、Qdrant、MinIO、Python、Node，均由容器提供。

- Windows: 安装 [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- macOS: 同上
- Linux: `docker` + `docker-compose`（或 `docker compose` 插件）

---

### 方式 B：本地开发（不用 Docker）

若要在本机直接跑后端和前端，需要：

| 环境 | 版本要求 | 用途 |
|------|----------|------|
| **Python** | 3.11+ | 后端 FastAPI |
| **Node.js** | 18+ | 前端 React 构建与开发 |
| **PostgreSQL** | 15+ | 主数据库 |
| **Redis** | 7+ | 缓存 / 会话 / Celery Broker |
| **Qdrant** | 最新 | 向量数据库（可选，未接 RAG 时可先不装） |
| **MinIO** 或 S3 | - | 文件存储（可选，可先改为本地目录） |

后端还需：`pip`、虚拟环境（推荐 `venv`）。  
前端还需：`npm` 或 `pnpm`。

---

## 二、必须的配置

配置通过**项目根目录**下的 `.env` 文件生效。若没有该文件，可从示例复制：

```bash
# 在项目根目录执行
cp .env.example .env
# 然后编辑 .env
```

### 1. Docker 方式下必配项（与 docker-compose 一致）

这些变量会传入容器，**必须与 docker-compose 里使用的名称一致**：

| 变量名 | 必填 | 说明 | 示例 |
|--------|------|------|------|
| `POSTGRES_PASSWORD` | 是 | 数据库密码（PostgreSQL） | `your_secure_password` |
| `MINIO_ROOT_USER` | 否 | MinIO 控制台用户名（默认 minioadmin） | `minioadmin` |
| `MINIO_ROOT_PASSWORD` | 否 | MinIO 控制台密码（默认 minioadmin123） | `minioadmin123` |
| `SECRET_KEY` | 建议 | 应用密钥，生产环境务必修改 | 随机长字符串 |
| `JWT_SECRET_KEY` | 建议 | JWT 签名密钥，生产环境务必修改 | 随机长字符串 |

说明：

- 数据库用户固定为 `rag_user`，数据库名为 `rag_db`，由 docker-compose 写死，无需在 `.env` 里再配 `POSTGRES_USER` / `POSTGRES_DB`。
- 后端容器里的 `DATABASE_URL` 由 compose 自动拼成：  
  `postgresql+asyncpg://rag_user:${POSTGRES_PASSWORD}@postgres:5432/rag_db`  
  因此只要在 `.env` 里正确设置 `POSTGRES_PASSWORD` 即可。

### 2. 后端应用本身会读的配置（config.py）

以下可在 `.env` 中设置，用于**本地直接跑 uvicorn** 或**覆盖容器内默认值**：

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `DATABASE_URL` | 数据库连接串（本地开发时用） | `postgresql+asyncpg://rag_user:password@localhost:5432/rag_db` |
| `REDIS_URL` | Redis 连接 | `redis://localhost:6379/0` |
| `QDRANT_URL` | Qdrant 地址 | `http://localhost:6333` |
| `MINIO_ENDPOINT` | MinIO 地址（Docker 内为 minio:9000） | `localhost:9000` |
| `MINIO_ACCESS_KEY` | MinIO Access Key | 同 MINIO_ROOT_USER |
| `MINIO_SECRET_KEY` | MinIO Secret Key | 同 MINIO_ROOT_PASSWORD |
| `OPENAI_API_KEY` | 调用 OpenAI 兼容 API 的密钥（如阿里云 DashScope） | 空 |
| `OPENAI_BASE_URL` | API 基地址（若用阿里云等需改） | `https://api.openai.com/v1` |

AI 与可选功能（RAG、OCR 等）会用到 `OPENAI_*`、`EMBEDDING_MODEL`、`LLM_MODEL` 等，可按需在 `.env` 中配置。

### 3. 你当前 .env 与 Docker 的对应关系

- 你已设置 `POSTGRES_PASSWORD=123456` → Docker 里数据库密码正确；后端容器里 `DATABASE_URL` 会自动用 `rag_user` + 该密码。
- `POSTGRES_USER=root` 在 **Docker 方式下不会生效**（compose 固定用 `rag_user`），可忽略或删掉，避免误解。
- MinIO 你设为 `MINIO_ROOT_USER=admin`、`MINIO_ROOT_PASSWORD=123456`，则建议在 `.env` 中同步：  
  `MINIO_ACCESS_KEY=admin`、`MINIO_SECRET_KEY=123456`（若 compose 未传这两项，后端从 config 读时会用你 .env 里的值）。

---

## 三、怎么启动

### 方式一：Docker Compose 一键启动（推荐）

1. **确认环境**  
   已安装 Docker、Docker Compose，且本机 5432、6379、6333、9000、9001、8000 端口未被占用。

2. **配置 .env**  
   在项目根目录确保存在 `.env`，并至少设置：
   - `POSTGRES_PASSWORD=你的数据库密码`
   - 生产环境务必设置：`SECRET_KEY`、`JWT_SECRET_KEY`

3. **构建并启动所有服务**

   ```bash
   cd e:\code\multi-model-rag
   docker-compose up -d --build
   ```

   首次会拉镜像、构建 backend 镜像，并启动：postgres、redis、qdrant、minio、backend、celery-worker。

4. **（可选）查看日志**

   ```bash
   docker-compose logs -f backend
   ```

5. **数据库表结构**  
   当前项目在 FastAPI 启动时通过 `Base.metadata.create_all` 自动建表，**无需**再执行 `alembic upgrade head`。只要后端能连上 PostgreSQL，访问一次 API 或 `/docs` 即会建表。

6. **访问地址**

   - 后端 API：http://localhost:8000  
   - API 文档：http://localhost:8000/docs  
   - MinIO 控制台：http://localhost:9001（用户名/密码为 MINIO_ROOT_USER / MINIO_ROOT_PASSWORD）

**前端**当前未在 docker-compose 中，需在本地单独启动（见下方「前端启动」）。

---

### 方式二：本地开发（后端 + 前端分开启动）

#### 1. 依赖服务（二选一）

- **用 Docker 只跑依赖**（推荐）：在项目根目录执行  
  `docker-compose up -d postgres redis qdrant minio`  
  不启动 backend 和 celery，端口同上。
- 或本机安装并启动 PostgreSQL、Redis、Qdrant、MinIO，并保证 `.env` 里 `DATABASE_URL`、`REDIS_URL`、`QDRANT_URL`、`MINIO_*` 指向本机。

#### 2. 后端

```bash
cd e:\code\multi-model-rag\backend
python -m venv venv
# Windows:
venv\Scripts\activate
# macOS/Linux:
# source venv/bin/activate
pip install -r requirements.txt
# 确保 .env 在项目根目录，且 DATABASE_URL 等指向正确
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

表会在首次请求时自动创建。

#### 3. 前端

```bash
cd e:\code\multi-model-rag\frontend
npm install
npm run dev
```

一般会跑在 http://localhost:5173，并代理 `/api` 到后端（见 `vite.config.ts`）。

#### 4. Celery（可选）

若需要异步任务：

```bash
cd backend
celery -A app.celery_app worker --loglevel=info
```

需保证 `CELERY_BROKER_URL`（如 Redis）可访问。

---

## 四、启动后检查

1. **后端健康**：浏览器打开 http://localhost:8000/health ，应返回 `{"status":"healthy","service":"rag-api"}`。
2. **API 文档**：http://localhost:8000/docs 可调试接口。
3. **注册/登录**：在前端注册用户后登录，再测文件上传、知识库、问答等。

---

## 五、常见问题

- **端口被占用**：修改 `docker-compose.yml` 中对应服务的 `ports`，或关闭占用端口的程序。
- **后端连不上数据库**：Docker 方式下检查 `POSTGRES_PASSWORD` 与 compose 中 `DATABASE_URL` 是否一致；本地方式检查 `DATABASE_URL` 的主机、端口、用户名、密码。
- **MinIO 上传失败**：检查 `MINIO_ENDPOINT`（Docker 内为 `minio:9000`）、`MINIO_ACCESS_KEY`、`MINIO_SECRET_KEY` 与 MinIO 实际配置一致。
- **前端 401**：多为未登录或 Token 过期，先在前端注册/登录再访问需鉴权的接口。

---

## 六、简要总结

| 项目 | 说明 |
|------|------|
| **必须环境（Docker）** | Docker + Docker Compose |
| **必须配置** | `.env` 中 `POSTGRES_PASSWORD`；生产环境加上 `SECRET_KEY`、`JWT_SECRET_KEY` |
| **一键启动** | 项目根目录执行：`docker-compose up -d --build` |
| **数据库表** | 由后端启动时自动创建，无需手动迁移 |
| **前端** | 在 `frontend` 目录执行 `npm install` 与 `npm run dev` |

按上述准备环境、配好 `.env`，再执行对应启动命令即可运行项目。
